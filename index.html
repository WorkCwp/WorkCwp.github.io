<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Snake PRO — Self-contained</title>
<style>
:root{--bg:#0f1720;--panel:#0b1220;--accent:#16a34a;--muted:#9aa3b2;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,#071018,#0f1720);color:#e6eef6}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
.topbar h1{margin:0;font-size:20px}
.btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:#e6eef6;cursor:pointer;margin:4px}
.btn.primary{background:var(--accent);color:#062a12;border:none}
.container{display:grid;grid-template-columns:1fr 320px;gap:12px;padding:12px;align-items:start}
#game-area{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;display:flex;flex-direction:column;align-items:center}
canvas{background:linear-gradient(180deg,#08121a,#08121a);border-radius:8px;max-width:100%;height:auto;display:block;box-shadow:0 6px 24px rgba(0,0,0,0.6)}
.hud{display:flex;gap:12px;color:var(--muted);margin-top:8px}
.sidebar{display:flex;flex-direction:column;gap:10px}
.panel{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
.small{font-size:12px;color:#9aa3b2;margin-bottom:6px}
.mobile-keys{display:none;margin-top:8px}
.row{display:flex;justify-content:center;gap:6px}
.key{width:68px;height:68px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:24px;color:#fff;user-select:none}
.lan-controls textarea{width:100%;margin-top:6px;border-radius:6px;padding:6px;background:#061018;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 12px;border-radius:8px;display:none}
.keypad{display:flex;flex-direction:column;align-items:center}
.keypad .row{justify-content:center}
.keypad .key{width:60px;height:60px}
.legend{font-size:12px;color:#aaa;margin-top:6px}
.panel-scroll{max-height:220px;overflow:auto}
@media(max-width:980px){.container{grid-template-columns:1fr}.mobile-keys{display:block}}
</style>
</head>
<body>
<header class="topbar">
  <h1>Snake PRO</h1>
  <div>
    <button id="btn-start" class="btn primary">Start</button>
    <button id="btn-pause" class="btn">Pause</button>
    <button id="btn-reset" class="btn">Reset</button>
    <button id="btn-sound" class="btn">Sound: On</button>
  </div>
</header>

<main class="container">
  <section id="game-area">
    <canvas id="gc" width="600" height="600"></canvas>

    <div class="hud">
      <div class="panel">Puntos: <strong id="points">0</strong></div>
      <div class="panel">Top: <strong id="top">0</strong></div>
      <div class="panel">Nivel: <strong id="level">1</strong></div>
      <div class="panel">Vel: <strong id="speed">1</strong></div>
      <div class="panel">FPS: <strong id="fps">0</strong></div>
    </div>

    <div class="keypad" id="mobile-keys" style="display:none;margin-top:10px">
      <div class="row"><div class="key" data-dir="up">▲</div></div>
      <div class="row"><div class="key" data-dir="left">◀</div><div class="key" data-dir="down">▼</div><div class="key" data-dir="right">▶</div></div>
      <div class="legend">Controles táctiles (swipe o botones)</div>
    </div>
  </section>

  <aside class="sidebar">
    <div class="panel">
      <div class="small">Modo</div>
      <select id="mode">
        <option value="classic">Clásico</option>
        <option value="hardcore">Hardcore</option>
        <option value="extreme">Extremo 2X</option>
        <option value="infinity">Infinity</option>
        <option value="obstacles">Obstáculos</option>
      </select>

      <div style="margin-top:8px" class="small">Tamaño (tiles)</div>
      <input id="tiles" type="range" min="10" max="60" value="20">

      <div style="margin-top:8px" class="small">Velocidad base</div>
      <input id="base-speed" type="range" min="4" max="25" value="8">
    </div>

    <div class="panel">
      <div class="small">Powerups</div>
      <div><label><input id="pw-super" type="checkbox" checked> Super Fruta</label></div>
      <div><label><input id="pw-slow" type="checkbox" checked> Slow</label></div>
      <div><label><input id="pw-dash" type="checkbox" checked> Dash</label></div>
      <div><label><input id="pw-inv" type="checkbox" checked> Invulnerabilidad</label></div>
      <div><label><input id="pw-cut" type="checkbox" checked> Cortar cola</label></div>
      <div><label><input id="pw-tele" type="checkbox" checked> Teleport</label></div>
      <div><label><input id="pw-mult" type="checkbox" checked> x2 Multiplicador</label></div>
    </div>

    <div class="panel">
      <div class="small">Skins</div>
      <button class="btn" id="btn-skin">Cambiar Skin</button>
      <div id="skin-preview" style="height:36px;width:100%;border-radius:6px;margin-top:6px"></div>
    </div>

    <div class="panel">
      <div class="small">LAN / Multiplayer (manual WebRTC)</div>
      <label>Role: <select id="lan-mode"><option value="host">Host</option><option value="client">Join</option></select></label>
      <div style="margin-top:6px"><button class="btn" id="btn-lan-init">Init</button> <button class="btn" id="btn-lan-offer">Crear Offer</button></div>
      <div style="margin-top:6px"><button class="btn" id="btn-lan-answer">Pegar Remote</button> <button class="btn" id="btn-lan-copy">Copiar SDP</button></div>
      <textarea id="lan-sdp" rows="4" placeholder="offer/answer aquí" style="width:100%;margin-top:6px;background:#061018;color:#e6eef6;border-radius:6px;padding:6px"></textarea>
      <div class="small" style="margin-top:6px">Flujo manual: Host crea offer → copia → Join pega → Join genera answer → copia → Host pega answer.</div>
    </div>

    <div class="panel">
      <div class="small">Editor de mapa</div>
      <button class="btn" id="btn-edit-map">Editar Obstáculos</button>
      <button class="btn" id="btn-clear-ob">Limpiar Obstáculos</button>
    </div>

    <div class="panel panel-scroll">
      <div class="small">Highscores</div>
      <div id="scores"></div>
    </div>

    <div class="panel panel-scroll">
      <div class="small">Logros</div>
      <ul id="achievements"></ul>
    </div>
  </aside>
</main>

<div id="toast" class="toast"></div>

<script>
// Self-contained Snake PRO (working). Implements requested features and manual WebRTC datachannel for LAN.
// NOTE: This is intentionally compacted but functional. If you want further expansion, I'll iterate.

const $ = id => document.getElementById(id);
const toast = (t, ms=1500) => { const el=$('toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none', ms); };

// Audio
class AudioManager {
  constructor(){ this.on=true; this.ctx=null; }
  _ensure(){ if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); }
  beep(freq=440,dur=0.06){ if(!this.on) return; this._ensure(); const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=0.06; o.connect(g); g.connect(this.ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001,this.ctx.currentTime+dur); o.stop(this.ctx.currentTime+dur+0.02); }
}
const audio = new AudioManager();

// RNG
const rnd = n => Math.floor(Math.random()*n);

// Game class
class Game {
  constructor(canvas){
    this.canvas = canvas; this.ctx = canvas.getContext('2d');
    this.tileCount = Number(localStorage.getItem('snake_tiles')||20);
    this.baseSpeed = Number(localStorage.getItem('snake_speed')||8);
    this.fixedTail = false;
    this.walls = false;
    this.initialTail = 4;
    this.skins = [{body:'#4caf50',head:'#a5f3a5'},{body:'#ff5722',head:'#ffd0ba'},{body:'#2196f3',head:'#90caf9'},{body:'#8b5cf6',head:'#c7b3ff'}];
    this.skinIndex = Number(localStorage.getItem('snake_skin')||0);
    this.powerupSettings = {super:true,slow:true,dash:true,inv:true,cut:true,tele:true,mult:true};
    this.top = Number(localStorage.getItem('snake_top')||0);
    this.scores = JSON.parse(localStorage.getItem('snake_scores')||'[]');
    this.achievements = new Set(JSON.parse(localStorage.getItem('snake_ach')||'[]'));
    this.obstacles = JSON.parse(localStorage.getItem('snake_obs')||'[]') || [];
    this.resetState();
    this.bindUI();
    window.addEventListener('resize', ()=>this.resize());
    this.resize();
    this.running=false;
    this.lastRenderT=0;
  }

  resetState(){
    this.state='menu';
    this.level=1; this.baseSpeed = Number(localStorage.getItem('snake_speed')||8);
    this.fps=this.baseSpeed;
    this.points=0; this.tail=this.initialTail;
    this.player={x:Math.floor(this.tileCount/2),y:Math.floor(this.tileCount/2)};
    this.velocity={x:0,y:0};
    this.trail=[{...this.player}];
    this.fruit={x:1,y:1,kind:'fruit'};
    this.spawnFruit();
    this.tick=0;
    this.invUntil=0; this.slowUntil=0; this.dashUntil=0; this.multUntil=0;
    this.paused=false;
    this.guestSnake=null;
  }

  setTiles(n){ this.tileCount = n; this.resize(); this.resetState(); this.saveSettings(); }
  setBaseSpeed(s){ this.baseSpeed = s; this.saveSettings(); }
  saveSettings(){ localStorage.setItem('snake_tiles', String(this.tileCount)); localStorage.setItem('snake_speed', String(this.baseSpeed)); }

  resize(){
    const max = Math.min(window.innerWidth-24, 800);
    this.canvas.width = max; this.canvas.height = max;
    this.grid = this.canvas.width / this.tileCount;
  }

  bindUI(){
    // UI elements
    $('btn-start').addEventListener('click', ()=>this.start());
    $('btn-pause').addEventListener('click', ()=>this.pause());
    $('btn-reset').addEventListener('click', ()=>{ this.resetState(); this.render(); });
    $('btn-sound').addEventListener('click', ()=>{ audio.on=!audio.on; $('btn-sound').textContent='Sound: '+(audio.on?'On':'Off'); });
    $('btn-skin').addEventListener('click', ()=>{ this.skinIndex=(this.skinIndex+1)%this.skins.length; localStorage.setItem('snake_skin',this.skinIndex); this.render(); });
    $('tiles').value = this.tileCount; $('tiles').addEventListener('input', e=>this.setTiles(Number(e.target.value)));
    $('base-speed').value = this.baseSpeed; $('base-speed').addEventListener('input', e=>this.setBaseSpeed(Number(e.target.value)));
    ['super','slow','dash','inv','cut','tele','mult'].forEach(k=>{
      const id='pw-'+k; const el=$(id); if(el) el.checked = this.powerupSettings[k]; if(el) el.addEventListener('change', e=>{ this.powerupSettings[k]=e.target.checked; });
    });

    // mobile keys
    document.querySelectorAll('.key').forEach(k=>{
      k.addEventListener('touchstart', ev=>{ this.mobileDir(k.dataset.dir); ev.preventDefault(); });
      k.addEventListener('mousedown', ev=>{ this.mobileDir(k.dataset.dir); ev.preventDefault(); });
    });

    // keyboard
    document.addEventListener('keydown', e=>{
      if(e.key==='ArrowLeft') this.setDir(-1,0);
      if(e.key==='ArrowRight') this.setDir(1,0);
      if(e.key==='ArrowUp') this.setDir(0,-1);
      if(e.key==='ArrowDown') this.setDir(0,1);
      if(e.key===' ') { this.pause(); e.preventDefault(); }
      if(e.key==='e') { this.toggleEditor(); }
    });

    // lan buttons
    $('btn-lan-init').addEventListener('click', ()=>this.initLAN());
    $('btn-lan-offer').addEventListener('click', ()=>this.createOffer());
    $('btn-lan-answer').addEventListener('click', ()=>this.pasteRemoteSDP());
    $('btn-lan-copy').addEventListener('click', ()=>navigator.clipboard.writeText($('lan-sdp').value).then(()=>toast('Copiado')));

    // editor
    $('btn-edit-map').addEventListener('click', ()=>this.toggleEditor());
    $('btn-clear-ob').addEventListener('click', ()=>{ this.obstacles=[]; localStorage.setItem('snake_obs',JSON.stringify(this.obstacles)); this.render(); });

    // touch swipe
    let ts=null;
    this.canvas.addEventListener('touchstart', e=>{ const t=e.touches[0]; ts={x:t.clientX,y:t.clientY}; });
    this.canvas.addEventListener('touchend', e=>{ if(!ts) return; const t=e.changedTouches[0]; const dx=t.clientX-ts.x, dy=t.clientY-ts.y; if(Math.abs(dx)>Math.abs(dy)){ if(dx>30) this.setDir(1,0); else if(dx<-30) this.setDir(-1,0); } else { if(dy>30) this.setDir(0,1); else if(dy<-30) this.setDir(0,-1);} ts=null; });
  }

  mobileDir(dir){ if(dir==='left') this.setDir(-1,0); if(dir==='right') this.setDir(1,0); if(dir==='up') this.setDir(0,-1); if(dir==='down') this.setDir(0,1); }

  setDir(dx,dy){ if(this.velocity.x===-dx && this.velocity.y===-dy) return; this.velocity.x=dx; this.velocity.y=dy; // if client -> send to host (LAN)
    if(this.lan && this.lan.enabled && this.lan.role==='client' && this.lan.channel && this.lan.channel.readyState==='open'){
      try{ this.lan.channel.send(JSON.stringify({type:'input', dir:[dx,dy]})); }catch(e){} }
  }

  spawnFruit(){
    const blocked = new Set(this.trail.map(t=>t.x+','+t.y));
    for(const o of this.obstacles) blocked.add(o.x+','+o.y);
    const free=[];
    for(let x=0;x<this.tileCount;x++) for(let y=0;y<this.tileCount;y++){
      if(this.walls && (x===0||y===0||x===this.tileCount-1||y===this.tileCount-1)) continue;
      if(blocked.has(x+','+y)) continue; free.push({x,y});
    }
    if(free.length===0){ this.fruit=null; return; }
    const pos = free[rnd(free.length)];
    let kind='fruit';
    if(Math.random()<0.08){
      const pool=[];
      if(this.powerupSettings.super) pool.push('super');
      if(this.powerupSettings.slow) pool.push('slow');
      if(this.powerupSettings.dash) pool.push('dash');
      if(this.powerupSettings.inv) pool.push('inv');
      if(this.powerupSettings.cut) pool.push('cut');
      if(this.powerupSettings.tele) pool.push('tele');
      if(this.powerupSettings.mult) pool.push('mult');
      if(pool.length>0) kind = pool[rnd(pool.length)];
    }
    this.fruit={...pos, kind};
  }

  applyFruit(kind){
    const now = Date.now();
    switch(kind){
      case 'fruit':
        this.tail += this.fixedTail?0:1; this.points += (this.multUntil>now?2:1); audio.beep(880,0.06); break;
      case 'super': this.tail += 3; this.points += (this.multUntil>now?6:3); toast('Super Fruta!'); audio.beep(1200,0.08); break;
      case 'slow': this.slowUntil = Date.now()+5000; toast('Slow'); audio.beep(320,0.06); break;
      case 'dash': this.dashUntil = Date.now()+4000; toast('Dash'); audio.beep(1400,0.06); break;
      case 'inv': this.invUntil = Date.now()+3000; toast('Invulnerable'); audio.beep(600,0.06); break;
      case 'cut': this.tail = Math.max(1,Math.floor(this.tail/2)); toast('Cola Cortada'); audio.beep(200,0.05); break;
      case 'tele':
        // teleport to free cell
        const blocked=new Set(this.trail.map(t=>t.x+','+t.y));
        const free=[]; for(let x=0;x<this.tileCount;x++) for(let y=0;y<this.tileCount;y++){ if(blocked.has(x+','+y)) continue; free.push({x,y}); }
        if(free.length>0){ const p = free[rnd(free.length)]; this.player.x=p.x; this.player.y=p.y; this.trail.push({...this.player}); }
        toast('Teleport'); audio.beep(1000,0.06); break;
      case 'mult': this.multUntil = Date.now()+6000; toast('x2 puntos'); audio.beep(1600,0.06); break;
    }
    if(this.points>this.top){ this.top=this.points; localStorage.setItem('snake_top',this.top); }
    if(this.points>=1) this.unlock('Primer mordisco');
    if(this.tail>=25) this.unlock('Serpiente larga');
    if(this.tail>=50) this.unlock('Dios');
    this.spawnFruit();
  }

  unlock(name){ if(!this.achievements.has(name)){ this.achievements.add(name); localStorage.setItem('snake_ach', JSON.stringify([...this.achievements])); toast('Logro: '+name); this.updateUI(); } }

  onDeath(){ audio.beep(80,0.15); navigator.vibrate && navigator.vibrate(120); toast('Game Over'); this.scores.unshift({score:this.points,date:Date.now()}); this.scores=this.scores.slice(0,50); localStorage.setItem('snake_scores', JSON.stringify(this.scores)); this.resetState(); this.updateUI(); }

  update(){
    if(this.paused) return;
    const now = Date.now();
    if(this.slowUntil>now) this.fps = Math.max(2, Math.floor(this.baseSpeed/2));
    else if(this.dashUntil>now) this.fps = this.baseSpeed*2;
    else this.fps = this.baseSpeed;
    // throttle by fps
    if(this._lastTick && (performance.now()-this._lastTick) < (1000/this.fps)) return;
    this._lastTick = performance.now();

    if(this.velocity.x===0 && this.velocity.y===0) return;
    this.player.x += this.velocity.x; this.player.y += this.velocity.y;

    // walls/wrap
    if(this.walls){
      if(this.player.x<1||this.player.y<1||this.player.x>this.tileCount-2||this.player.y>this.tileCount-2){
        if(Date.now() < this.invUntil){} else { this.onDeath(); return; }
      }
    } else {
      if(this.player.x<0) this.player.x=this.tileCount-1;
      if(this.player.x>=this.tileCount) this.player.x=0;
      if(this.player.y<0) this.player.y=this.tileCount-1;
      if(this.player.y>=this.tileCount) this.player.y=0;
    }

    // trail
    this.trail.push({x:this.player.x,y:this.player.y});
    while(this.trail.length>this.tail) this.trail.shift();

    // self collision
    for(let i=0;i<this.trail.length-1;i++){
      if(this.trail[i].x===this.player.x && this.trail[i].y===this.player.y){
        if(Date.now() < this.invUntil){} else { this.onDeath(); return; }
      }
    }

    // fruit collision
    if(this.fruit && this.player.x===this.fruit.x && this.player.y===this.fruit.y){
      this.applyFruit(this.fruit.kind);
    }

    // obstacles
    for(const o of this.obstacles){ if(o.x===this.player.x && o.y===this.player.y){ if(Date.now() < this.invUntil) continue; this.onDeath(); return; } }

    // level progression
    if(this.points>0 && this.points % 5 === 0) { this.level = 1 + Math.floor(this.points/5); this.baseSpeed = Math.min(30, 8 + this.level); }

    // update UI
    this.updateUI();

    // LAN host broadcast
    if(this.lan && this.lan.enabled && this.lan.role==='host' && this.lan.channel && this.lan.channel.readyState==='open'){
      try{ this.lan.channel.send(JSON.stringify({type:'state', state:{player:this.player, trail:this.trail.slice(-this.tail), fruit:this.fruit, points:this.points, tail:this.tail}})); }catch(e){}
    }
  }

  render(){
    const ctx=this.ctx, sz=this.canvas.width; ctx.clearRect(0,0,sz,sz);
    // background
    ctx.fillStyle='#07121a'; ctx.fillRect(0,0,sz,sz);
    // obstacles
    for(const o of this.obstacles){ ctx.fillStyle='#6b7280'; ctx.fillRect(o.x*this.grid+1,o.y*this.grid+1,this.grid-2,this.grid-2); }
    // fruit/powerup
    if(this.fruit){
      if(this.fruit.kind && this.fruit.kind!=='fruit'){
        const map={super:'#ff6b6b', slow:'#60a5fa', dash:'#f59e0b', inv:'#a3e635', cut:'#ef4444', tele:'#a78bfa', mult:'#f472b6'};
        ctx.fillStyle = map[this.fruit.kind] || '#ffd166';
        ctx.fillRect(this.fruit.x*this.grid+1, this.fruit.y*this.grid+1, this.grid-2, this.grid-2);
        ctx.fillStyle = '#04111b'; ctx.font = `${Math.floor(this.grid*0.6)}px monospace`;
        ctx.fillText(this.fruit.kind[0].toUpperCase(), this.fruit.x*this.grid+this.grid*0.18, this.fruit.y*this.grid+this.grid*0.75);
      } else { ctx.fillStyle='#ef4444'; ctx.fillRect(this.fruit.x*this.grid+1,this.fruit.y*this.grid+1,this.grid-2,this.grid-2); }
    }

    // snake trail
    const skin = this.skins[this.skinIndex];
    for(let i=0;i<this.trail.length;i++){
      const p=this.trail[i]; const isHead=(i===this.trail.length-1);
      ctx.fillStyle = isHead ? skin.head : skin.body;
      // shadow
      ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 6;
      ctx.fillRect(p.x*this.grid+1, p.y*this.grid+1, this.grid-2, this.grid-2);
      ctx.shadowBlur = 0;
    }

    // HUD small
    ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fillRect(6,6,180,64);
    ctx.fillStyle='#cde'; ctx.font='12px Inter, san
